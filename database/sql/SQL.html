<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>SQL 基础 | DeathKnightH&#39;s blog</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="记录一些思路和细节">
    
    <link rel="preload" href="/assets/css/0.styles.e4d8b86b.css" as="style"><link rel="preload" href="/assets/js/app.a49e69aa.js" as="script"><link rel="preload" href="/assets/js/2.afe9fb9e.js" as="script"><link rel="preload" href="/assets/js/46.7b041a63.js" as="script"><link rel="prefetch" href="/assets/js/10.431cb00e.js"><link rel="prefetch" href="/assets/js/100.0b6ce755.js"><link rel="prefetch" href="/assets/js/101.b801bad7.js"><link rel="prefetch" href="/assets/js/11.08936fed.js"><link rel="prefetch" href="/assets/js/12.849e6d90.js"><link rel="prefetch" href="/assets/js/13.3234687d.js"><link rel="prefetch" href="/assets/js/14.3c7118bf.js"><link rel="prefetch" href="/assets/js/15.7c52bb70.js"><link rel="prefetch" href="/assets/js/16.44d84432.js"><link rel="prefetch" href="/assets/js/17.4687390f.js"><link rel="prefetch" href="/assets/js/18.5916a6df.js"><link rel="prefetch" href="/assets/js/19.6ef85581.js"><link rel="prefetch" href="/assets/js/20.ec152460.js"><link rel="prefetch" href="/assets/js/21.d4d6bb81.js"><link rel="prefetch" href="/assets/js/22.5c880af5.js"><link rel="prefetch" href="/assets/js/23.a999f731.js"><link rel="prefetch" href="/assets/js/24.4d774f46.js"><link rel="prefetch" href="/assets/js/25.8aafa382.js"><link rel="prefetch" href="/assets/js/26.77483636.js"><link rel="prefetch" href="/assets/js/27.93a5d5ab.js"><link rel="prefetch" href="/assets/js/28.255dd8d5.js"><link rel="prefetch" href="/assets/js/29.cd58b4a9.js"><link rel="prefetch" href="/assets/js/3.46e6989e.js"><link rel="prefetch" href="/assets/js/30.d9db0df5.js"><link rel="prefetch" href="/assets/js/31.30408f47.js"><link rel="prefetch" href="/assets/js/32.03d97f0f.js"><link rel="prefetch" href="/assets/js/33.4a79beb1.js"><link rel="prefetch" href="/assets/js/34.5b4397db.js"><link rel="prefetch" href="/assets/js/35.88faa5d3.js"><link rel="prefetch" href="/assets/js/36.90464536.js"><link rel="prefetch" href="/assets/js/37.34c323c6.js"><link rel="prefetch" href="/assets/js/38.6b9a463c.js"><link rel="prefetch" href="/assets/js/39.e125cbe3.js"><link rel="prefetch" href="/assets/js/4.c49013a1.js"><link rel="prefetch" href="/assets/js/40.0afc3f44.js"><link rel="prefetch" href="/assets/js/41.c7a14b1c.js"><link rel="prefetch" href="/assets/js/42.a88cf117.js"><link rel="prefetch" href="/assets/js/43.05071266.js"><link rel="prefetch" href="/assets/js/44.e7cd54c4.js"><link rel="prefetch" href="/assets/js/45.cc7fd848.js"><link rel="prefetch" href="/assets/js/47.97c24fb4.js"><link rel="prefetch" href="/assets/js/48.59d89ed7.js"><link rel="prefetch" href="/assets/js/49.193275c2.js"><link rel="prefetch" href="/assets/js/5.c11365e2.js"><link rel="prefetch" href="/assets/js/50.6934cb10.js"><link rel="prefetch" href="/assets/js/51.257ac627.js"><link rel="prefetch" href="/assets/js/52.d9f83291.js"><link rel="prefetch" href="/assets/js/53.c3d64566.js"><link rel="prefetch" href="/assets/js/54.0acfd0a0.js"><link rel="prefetch" href="/assets/js/55.7fa83fe8.js"><link rel="prefetch" href="/assets/js/56.c3cecb40.js"><link rel="prefetch" href="/assets/js/57.93ab6ad2.js"><link rel="prefetch" href="/assets/js/58.ada241c4.js"><link rel="prefetch" href="/assets/js/59.53ac9c67.js"><link rel="prefetch" href="/assets/js/6.55c03514.js"><link rel="prefetch" href="/assets/js/60.2176f812.js"><link rel="prefetch" href="/assets/js/61.c8f36f1c.js"><link rel="prefetch" href="/assets/js/62.757a389a.js"><link rel="prefetch" href="/assets/js/63.f89b2b8b.js"><link rel="prefetch" href="/assets/js/64.ae48d1f9.js"><link rel="prefetch" href="/assets/js/65.2f1ec9da.js"><link rel="prefetch" href="/assets/js/66.45db3f5f.js"><link rel="prefetch" href="/assets/js/67.9c98bf08.js"><link rel="prefetch" href="/assets/js/68.f1854c7c.js"><link rel="prefetch" href="/assets/js/69.9e5237c8.js"><link rel="prefetch" href="/assets/js/7.be40de1f.js"><link rel="prefetch" href="/assets/js/70.5d65fe07.js"><link rel="prefetch" href="/assets/js/71.07587723.js"><link rel="prefetch" href="/assets/js/72.e72601c2.js"><link rel="prefetch" href="/assets/js/73.0b8ed8da.js"><link rel="prefetch" href="/assets/js/74.a0b12112.js"><link rel="prefetch" href="/assets/js/75.244adec8.js"><link rel="prefetch" href="/assets/js/76.6bef75ae.js"><link rel="prefetch" href="/assets/js/77.d596d7d6.js"><link rel="prefetch" href="/assets/js/78.e97efb09.js"><link rel="prefetch" href="/assets/js/79.803286d8.js"><link rel="prefetch" href="/assets/js/8.3c14a344.js"><link rel="prefetch" href="/assets/js/80.4afcd23b.js"><link rel="prefetch" href="/assets/js/81.43d9bc6d.js"><link rel="prefetch" href="/assets/js/82.a3d938d9.js"><link rel="prefetch" href="/assets/js/83.adb50570.js"><link rel="prefetch" href="/assets/js/84.e067ad72.js"><link rel="prefetch" href="/assets/js/85.4f80d078.js"><link rel="prefetch" href="/assets/js/86.4e54f025.js"><link rel="prefetch" href="/assets/js/87.42b5e33b.js"><link rel="prefetch" href="/assets/js/88.d5652c16.js"><link rel="prefetch" href="/assets/js/89.f063be81.js"><link rel="prefetch" href="/assets/js/9.e79519c5.js"><link rel="prefetch" href="/assets/js/90.55ed2d6a.js"><link rel="prefetch" href="/assets/js/91.4486f9de.js"><link rel="prefetch" href="/assets/js/92.f49122a9.js"><link rel="prefetch" href="/assets/js/93.451b0e8e.js"><link rel="prefetch" href="/assets/js/94.440efd37.js"><link rel="prefetch" href="/assets/js/95.e0ed3764.js"><link rel="prefetch" href="/assets/js/96.da2b4bb2.js"><link rel="prefetch" href="/assets/js/97.2cbc5e66.js"><link rel="prefetch" href="/assets/js/98.11638cb2.js"><link rel="prefetch" href="/assets/js/99.b9bc5935.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e4d8b86b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">DeathKnightH's blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/algorithm/" class="nav-link">
  算法笔记
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java基础" class="dropdown-title"><span class="title">Java基础</span> <span class="arrow down"></span></button> <button type="button" aria-label="Java基础" class="mobile-dropdown-title"><span class="title">Java基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/java/" class="nav-link">
  总览
</a></li><li class="dropdown-item"><!----> <a href="/java/thread/" class="nav-link">
  多线程
</a></li><li class="dropdown-item"><!----> <a href="/java/jvm/" class="nav-link">
  JVM
</a></li></ul></div></div><div class="nav-item"><a href="/database/" class="nav-link router-link-active">
  数据库
</a></div><div class="nav-item"><a href="/tools/" class="nav-link">
  常用工具
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/algorithm/" class="nav-link">
  算法笔记
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java基础" class="dropdown-title"><span class="title">Java基础</span> <span class="arrow down"></span></button> <button type="button" aria-label="Java基础" class="mobile-dropdown-title"><span class="title">Java基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/java/" class="nav-link">
  总览
</a></li><li class="dropdown-item"><!----> <a href="/java/thread/" class="nav-link">
  多线程
</a></li><li class="dropdown-item"><!----> <a href="/java/jvm/" class="nav-link">
  JVM
</a></li></ul></div></div><div class="nav-item"><a href="/database/" class="nav-link router-link-active">
  数据库
</a></div><div class="nav-item"><a href="/tools/" class="nav-link">
  常用工具
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>SQL 基础</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/database/sql/SQL.html#_1-语法基础" class="sidebar-link">1. 语法基础</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/database/sql/SQL.html#_1-1-ddl" class="sidebar-link">1.1 DDL</a></li><li class="sidebar-sub-header"><a href="/database/sql/SQL.html#_1-2-dml" class="sidebar-link">1.2 DML</a></li></ul></li><li><a href="/database/sql/SQL.html#_2-存储程序" class="sidebar-link">2. 存储程序</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/database/sql/SQL.html#_2-1-复合语句" class="sidebar-link">2.1 复合语句</a></li><li class="sidebar-sub-header"><a href="/database/sql/SQL.html#_2-2-存储函数" class="sidebar-link">2.2 存储函数</a></li><li class="sidebar-sub-header"><a href="/database/sql/SQL.html#_2-3-存储过程" class="sidebar-link">2.3 存储过程</a></li><li class="sidebar-sub-header"><a href="/database/sql/SQL.html#_2-4-触发器" class="sidebar-link">2.4 触发器</a></li><li class="sidebar-sub-header"><a href="/database/sql/SQL.html#_2-5-事件" class="sidebar-link">2.5 事件</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="sql-基础"><a href="#sql-基础" class="header-anchor">#</a> SQL 基础</h1> <p>Structured Query Language（SQL，结构化查询语言）又称 ANSI SQL，由 ANSI 标准委员会管理。具体商业应用中每个数据库产品通常都有自己的 SQL 增强实现，比如 oracle 的 PL/SQL，sql server 的 Transact-SQL。</p> <h2 id="_1-语法基础"><a href="#_1-语法基础" class="header-anchor">#</a> 1. 语法基础</h2> <h3 id="_1-1-ddl"><a href="#_1-1-ddl" class="header-anchor">#</a> 1.1 DDL</h3> <p>Data definition language 数据定义语言。现在常用的数据库设计软件都可以直接导出 DDL 语句，通常不会自己手写 DDL，这里只列举一下常用 DDL 的使用方法，不做深入研究。</p> <h4 id="数据库"><a href="#数据库" class="header-anchor">#</a> 数据库</h4> <div class="language- line-numbers-mode"><pre class="language-text"><code>CREATE DATABASE test; // 创建名为 test 的数据库
USE test; // 使用名为 test 的数据库
DROP DATABASE test; // 删除名为 test 的数据库
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h4 id="表"><a href="#表" class="header-anchor">#</a> 表</h4> <div class="language- line-numbers-mode"><pre class="language-text"><code>CREATE TABLE testtable(
  column1 datatype1,
  ...
  columnn datatypen
  {,key define}{,index define}
); // 创建名为 testtable 的数据表

DROP TABLE testtable; // 删除名为 testtable 的数据表

ALTER TABLE testtable ADD columnx datatypex; // 修改数据表，增加列
ALTER TABLE testtable DROP COLUMN column1;   // 修改数据表，删除列 column1
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h4 id="视图"><a href="#视图" class="header-anchor">#</a> 视图</h4> <div class="language- line-numbers-mode"><pre class="language-text"><code>CREATE VIEW testview AS subquery; // 根据子查询 subquery 创建视图 testview
DROP VIEW testview; // 删除视图 testview
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="_1-2-dml"><a href="#_1-2-dml" class="header-anchor">#</a> 1.2 DML</h3> <p>Data manipulation language 数据操纵语言。日常开发中使用频率最高的 sql，通常说的增删改查都属于 DML。</p> <h4 id="_1-2-1-insert-插入"><a href="#_1-2-1-insert-插入" class="header-anchor">#</a> 1.2.1 insert 插入</h4> <ul><li>普通插入，将一条记录插入 tablename 表，其中 column1 值为 value1，column2 值为 value2。</li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>INSERT INTO tablename(column1, column2)
VALUES(value1, value2);
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ul><li>将查询结果集直接插入。</li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>INSERT INTO tablename(column1, column2)
SELECT col1, col2
FROM table2;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h4 id="_1-2-2-update-更新"><a href="#_1-2-2-update-更新" class="header-anchor">#</a> 1.2.2 update 更新</h4> <p>更新 tablename 表，将其中所有符合 condition 记录的 column1 属性更新为 value1</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>UPDATE tablename
SET column1 = value1
WHERE condition;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h4 id="_1-2-3-delete-删除"><a href="#_1-2-3-delete-删除" class="header-anchor">#</a> 1.2.3 delete 删除</h4> <p>删除 tablename 表中所有符合 condition 的记录，如果 condition 恒为 true，则删除表的所有记录。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>DELETE FROM tablename
WHERE condition;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>还有一个 DDL 语句可以实现删除表的所有记录：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>TRUNCATE TABLE tablename;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="_1-2-4-select-查询"><a href="#_1-2-4-select-查询" class="header-anchor">#</a> 1.2.4 select 查询</h4> <ul><li>基本查询</li></ul> <p>查询 tablename 表中的所有数据。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>SELECT * FROM tablename;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>也可以不跟 <code>FROM</code> 子句，用于直接计算表达式。常用于检查数据库连接，比如：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>SELECT 1;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>条件查询</li></ul> <p>可以只查询符合条件的数据。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>SELECT * FROM tablename 
WHERE condition;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><code>condition</code> 由逻辑表达式或者子条件组成，各子条件可以由 <code>NOT</code>/<code>AND</code>/<code>OR</code> 来修饰和连接。
不使用括号时，优先级从高到低依次是 <code>NOT</code>/<code>AND</code>/<code>OR</code>。</p> <ul><li>投影查询</li></ul> <p>可以只查询部分属性(列)，这种操作称为投影。同时列名也可以映射为自定义的名称：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>SELECT column1 AS col1, column2 AS col2
FROM tablename
WHERE condition;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>查询 <code>tablename</code> 表中符合 <code>condition</code> 条件的数据，最后只显示 column1 和 column2 的属性值，同时将 column1 的名称映射为 col1，将 column2 的名称映射为 col2.</p> <ul><li>查询结果排序</li></ul> <p>查询结果默认是以主键排序的。用户可以使用 <code>ORDER BY</code> 子句实现自定义的结果集排序：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>SELECT id, name, age
FROM person
WHERE id &lt; 100
ORDER BY age;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>顺序分为升序(ASC) 和降序(DESC)，默认不写就是升序，如果使用降序：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>SELECT id, name, age
FROM person
WHERE id &lt; 100
ORDER BY age DESC;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>可以同时对多列属性进行排序，比如有两个列参与排序：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>SELECT id, name, age, score
FROM person
WHERE id &lt; 100
ORDER BY age DESC, score;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>先按照 age 倒序排列，age 属性相同时按照 score 正序排列。</p> <ul><li>查询结果分组</li></ul> <p>使用 <code>GROUP BY</code> 子句对结果集进行分组：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>SELECT age, score, count(*) AS sum
FROM person
WHERE id &lt; 100
GROUP BY age, score
ORDER BY sum;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>1、<code>GROUP BY</code> 在 <code>WHERE</code> 后，<code>ORDER BY</code> 前。</p> <p>2、<code>SELECT</code> 子句选择的属性必须在 <code>GROUP BY</code> 中出现（除汇总函数外，例如 count(*)）。</p> <p>3、如果分组的属性在某些记录中为 NULL，则 NULL 会单独分组。</p> <ul><li>分页查询</li></ul> <p>当结果集过大而一次不用使用全部结果集时，可以使用 <code>LIMIT m OFFSET n</code> 子句进行手动分页：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>SELECT id, name, age, score
FROM person
ORDER BY age DESC, score
LIMIT 5 OFFSET 0;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>每页5条记录，当前取第1页。</p> <ul><li>连接查询
<ul><li>内连接，又称等值连接，只保留两表匹配字段。</li> <li>左(外)连接，保留左侧表未匹配字段。</li> <li>右(外)连接，保留右侧表未匹配字段。</li> <li>全外连接 ，保留所有未匹配字段。</li></ul></li> <li>笛卡尔积查询</li></ul> <p>假设有两张表，记录数分别为 M 和 N，将两张表的记录一一组合形成 M*N 行记录的结果集就是笛卡尔积。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>SELECT * 
FROM students, classes;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>实际应用中要尽量避免使用笛卡尔积，因为查询结果可能会很大，比如两张超过1万条记录的表进行笛卡尔积查询，结果集超过1亿条。</p> <ul><li>组合查询</li></ul> <p>使用 <code>UNION</code> 关键字可以将两个查询结果组合起来，两个查询结果集分别为 M 行和 N 行，则组合结果有 M + N 行。</p> <p>使用前提是两个查询结果集列一致。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>SELECT name,age,score
FROM student1
WHERE age = 10
UNION
SELECT name,age,score
FROM student2
WHERE age = 18
ORDER BY score;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>组合查询只能有一个 <code>ORDER BY</code> 子句，且必须在最后。</p> <p>默认会去重，如果不去重，需要使用 <code>UNION ALL</code> 关键字。</p> <ul><li>子查询</li></ul> <p>子查询也是查询的一种，结果集只能有 1 列。结果集常用做其他查询的条件/结果的组成部分。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>SELECT *
FROM student
WHERE classid IN(SELECT classid
                  FROM class
                  WHERE rank &gt; 1)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h2 id="_2-存储程序"><a href="#_2-存储程序" class="header-anchor">#</a> 2. 存储程序</h2> <p>Stored Program 是一种存储对象，功能和高级语言编写的程序类似，封装了一系列的 SQL 操作，有的可以被调用、有的可以被触发。</p> <p><em>ps:由于存储程序大多依赖于具体数据库实现，这里仅以 MySQL 为例进行描述。</em></p> <h3 id="_2-1-复合语句"><a href="#_2-1-复合语句" class="header-anchor">#</a> 2.1 复合语句</h3> <p>编写存储程序常用到复合语句，这种语句包含多条 SQL 语句，同时还可以使用逻辑判断/条件语句/循环/变量，每个语句由分号 <code>;</code> 结束。</p> <p>整体的复合语句由 <code>BEGIN</code> 开始，<code>END;</code> 结束。</p> <p>特别的，如果使用MySQL客户端命令行编写复合语句，由于 <code>;</code> 同时也是客户端的默认分隔符，可以使用 <code>delimiter</code> 命令将分隔符先临时改为其他符号，在编写完复合语句后再改回来，以包含在存储过程中的复合语句为例：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>delimiter $
CREATE PROCEDURE test()
BEGIN
  SELECT ...... ;
  SELECT ...... ;
END$
delimiter ;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="_2-2-存储函数"><a href="#_2-2-存储函数" class="header-anchor">#</a> 2.2 存储函数</h3> <p>Stored Function 可以看做用户自定义的函数，创建/修改存储函数需要有管理权限。</p> <p>存储函数不能修改数据，只能包含查询语句和计算过程。基本语法如下:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>CREATE FUNCTION test([param_list])
  RETURN type
  routine_stmt # 复合语句
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>存储函数有且只能有一个返回值。要返回多个值，要么在一个查询语句中调用多个存储函数，要么使用存储过程。</p> <p>调用存储函数和使用系统内建函数一样（如果和内建函数同名，需要在前面加数据库限定名），直接在表达式中使用。</p> <h3 id="_2-3-存储过程"><a href="#_2-3-存储过程" class="header-anchor">#</a> 2.3 存储过程</h3> <p>Stored procedure 可以看做一组预编译的 SQL 集合，SQL 能做的操作，存储过程基本都能做。</p> <p>存储过程不包含 RETURN 子句，基本语法如下：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>CREATE FUNCTION test([param_list])
  routine_stmt # 复合语句
  
CALL test([param_list]); # 调用存储过程
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>存储过程的参数分为3种类型：</p> <ul><li><code>IN</code> 默认类型，传入参数，存储过程可以把这个参数作为变量使用，也可以在过程中修改此参数，但是修改对调用者不可见。</li> <li><code>OUT</code> 传出参数，存储过程可以通过 <code>SET</code> 子句赋值给这些变量，而调用者可以在过程返回后，可以使用这些参数获取返回值。</li> <li><code>INOUT</code>顾名思义，同时作为传入和传出参数，类似代码中的引用传递。</li></ul> <p>与存储函数的区别：</p> <table><thead><tr><th></th> <th>返回值</th> <th>参数</th> <th>能否修改数据库中的数据</th> <th>调用方式</th></tr></thead> <tbody><tr><td>存储函数</td> <td>用RETURN子句返回，只能有1个返回值</td> <td>只有 <code>IN</code> 参数</td> <td>不能</td> <td>直接在表达式中使用，和内建函数一样</td></tr> <tr><td>存储过程</td> <td>通过 <code>OUT</code> 或 <code>INOUT</code> 类型参数返回，可以有多个</td> <td>可以有 <code>IN</code>/<code>OUT</code>/<code>INOUT</code>等 3 种参数</td> <td>能</td> <td>必须使用 <code>CALL</code> 子句调用</td></tr></tbody></table> <h3 id="_2-4-触发器"><a href="#_2-4-触发器" class="header-anchor">#</a> 2.4 触发器</h3> <p>Trigger 可以看做和特定表关联的存储过程，其中定义的内容会在执行特定表的 <code>INSERT</code>/<code>DELETE</code>/<code>UPDATE</code> 语句时被自动激活，激活时机可以设置在语句执行前或者执行后。</p> <p>定义触发器时需要显式指定触发它的语句类型和触发时机，基本语法如下：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>CREATE TRIGGER trigger_test
  {BEFORE | AFTER}
  {INSERT | UPDATE | DELETE}
  ON table_name             # 关联表
  FOR EACH ROW trigger_stmt # 触发器内容
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>在触发器内容体内可以使用 <code>NEW</code> 限定名代指 <code>INSERT</code> 或 <code>UPDATE</code> 操作中被插入或修改的新行数据，用 <code>NEW.column</code> 表示该行的某一个属性。</p> <p>相同的，可以使用 <code>OLD</code> 限定名代指 <code>DELETE</code> 或 <code>UPDATE</code> 操作中被删除或修改的旧行数据，用 <code>OLD.column</code> 表示该行的某个属性。</p> <p>需要注意的是触发器的权限属于特定表，需要拥有对应表的 <code>TRIGGER</code> 权限才能创建/删除触发器。</p> <h3 id="_2-5-事件"><a href="#_2-5-事件" class="header-anchor">#</a> 2.5 事件</h3> <p>MySQL 有内置的事件调度器，可以拥有定时执行一系列的数据库操作。默认是不会启用的，要使用事件调度器执行事件需要先设置配置项：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>SET GLOBAL event_scheduler = ON;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>事件定义由计划时间和事件内容组成，基本语法如下：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>CREATE EVENT event_name
  ON SCHEDULE {AT datetime | EVERY expr interval [STARTS datetime] [ENDS datetime]}
  DO event_stmt
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>例如，每4小时清理历史记录表中超过一天的记录：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>CREATE EVENT expire_web_history
  ON SCHEDULE EVERY 4 HOUR
  DO
    DELETE FROM web_history
    WHERE last_visit &lt; CURRENT_TIMESTAMP - INTERVAL 1 DAY;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">12/7/2021, 9:27:10 AM</span></div></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.a49e69aa.js" defer></script><script src="/assets/js/2.afe9fb9e.js" defer></script><script src="/assets/js/46.7b041a63.js" defer></script>
  </body>
</html>
